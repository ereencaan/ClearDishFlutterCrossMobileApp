# iPad Pro 12.9" ekran görüntüleri alır (App Store Connect için).
# Repo public ise macOS dakikaları ücretsiz kotaya dahildir.
# Çalıştır: Actions → "iPad Screenshots" → Run workflow → Run
# Bitince: Job'a tıkla → Artifacts → ipad-screenshots indir.

name: iPad Screenshots

on:
  workflow_dispatch:

jobs:
  ipad-screenshots:
    runs-on: macos-15  # Xcode 16+ gerekli (in_app_purchase_storekit winBack API)
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS (simulator)
        run: flutter build ios --simulator --no-codesign

      - name: List available iPad simulators
        run: xcrun simctl list devices available | grep -i "ipad" || true

      - name: Boot iPad Pro simulator (12.9" veya 13-inch)
        run: |
          # 12.9" / 13-inch iPad Pro (Xcode'da bazen "iPad Pro 13-inch (M4)" olur)
          UUID=$(xcrun simctl list devices available | grep -E "iPad Pro.*(12\.9|13-inch)" | head -1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          if [ -z "$UUID" ]; then
            UUID=$(xcrun simctl list devices available | grep "iPad Pro" | head -1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          fi
          if [ -z "$UUID" ]; then
            echo "iPad Pro bulunamadı. Tüm cihazlar:"
            xcrun simctl list devices available
            exit 1
          fi
          echo "Booting iPad Pro (UUID: $UUID)"
          xcrun simctl boot "$UUID" 2>/dev/null || true
          sleep 5

      - name: Install app on simulator
        run: |
          APP_PATH=$(find build/ios -name "Runner.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "Runner.app bulunamadı"
            find build -name "*.app" -type d
            exit 1
          fi
          echo "Installing: $APP_PATH"
          xcrun simctl install booted "$APP_PATH"

      - name: Launch app and take screenshots (3 different screens)
        run: |
          mkdir -p screenshots
          # 1) Welcome
          xcrun simctl launch booted -e INITIAL_LOCATION /welcome com.hitratech.cleardish
          sleep 8
          xcrun simctl io booted screenshot screenshots/ipad-12.9-1.png
          xcrun simctl terminate booted com.hitratech.cleardish
          sleep 2
          # 2) Login
          xcrun simctl launch booted -e INITIAL_LOCATION /login/user com.hitratech.cleardish
          sleep 8
          xcrun simctl io booted screenshot screenshots/ipad-12.9-2.png
          xcrun simctl terminate booted com.hitratech.cleardish
          sleep 2
          # 3) Onboarding
          xcrun simctl launch booted -e INITIAL_LOCATION /onboarding com.hitratech.cleardish
          sleep 8
          xcrun simctl io booted screenshot screenshots/ipad-12.9-3.png
          xcrun simctl terminate booted com.hitratech.cleardish
          echo "Screenshots:"
          ls -la screenshots/

      - name: Upload iPad screenshots
        uses: actions/upload-artifact@v4
        with:
          name: ipad-screenshots
          path: screenshots/
          retention-days: 30
