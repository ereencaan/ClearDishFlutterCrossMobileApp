workflows:
  ios_testflight:
    name: iOS - Build & Upload to TestFlight (no local Mac)
    max_build_duration: 60
    environment:
      # Import variable group(s) from Codemagic UI (required for secrets in a group).
      groups:
        - appstore
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        # Must match `ios/Runner.xcodeproj` settings.
        BUNDLE_ID: "com.hitratech.cleardish"
        # Optional: if you want to override pubspec versioning.
        # BUILD_NAME: "1.0.0"
        # BUILD_NUMBER: "2"
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true
        - pattern: ereen
          include: true
          source: true
    scripts:
      - name: Flutter pub get
        script: |
          flutter pub get

      # Codemagic automatic code signing via App Store Connect API key.
      # Requires setting the following secrets in Codemagic UI:
      # - APP_STORE_CONNECT_KEY_IDENTIFIER
      # - APP_STORE_CONNECT_ISSUER_ID
      # - APP_STORE_CONNECT_PRIVATE_KEY  (contents of the .p8 file)
      - name: Set up keychain & signing (automatic)
        script: |
          set -euo pipefail
          keychain initialize

          # Normalize App Store Connect API private key (AuthKey_*.p8).
          # Codemagic CLI expects a PEM encoded key. If the key is pasted as a single line
          # or with escaped/newline issues, this reformats it to a valid PEM.
          raw_key="${APP_STORE_CONNECT_PRIVATE_KEY:-}"
          if [[ -z "$raw_key" ]]; then
            echo "APP_STORE_CONNECT_PRIVATE_KEY is empty. Check Codemagic Environment variables (group: appstore)."
            exit 1
          fi

          # Convert any literal '\n' to real newlines and drop CR.
          raw_key="$(printf "%b" "$raw_key" | tr -d '\r')"

          if echo "$raw_key" | grep -q "BEGIN PRIVATE KEY"; then
            # Rebuild PEM with clean base64 body and standard line wraps.
            body="$(echo "$raw_key" | sed -e '1,/BEGIN PRIVATE KEY/d' -e '/END PRIVATE KEY/,$d' | tr -d '\n ' )"
            pem="-----BEGIN PRIVATE KEY-----\n$(echo "$body" | fold -w 64)\n-----END PRIVATE KEY-----\n"
            export APP_STORE_CONNECT_PRIVATE_KEY="$(printf "%b" "$pem")"
          fi

          app-store-connect fetch-signing-files "$BUNDLE_ID" --type IOS_APP_STORE --create
          keychain add-certificates
          xcode-project use-profiles

      - name: Build IPA
        script: |
          flutter build ipa --release

    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive
      - flutter_drive.log

    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        # Set to true only when you're ready for review automation (usually keep false initially).
        submit_to_app_store: false
